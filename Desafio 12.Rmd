---
title: 'Atividade: Reprodução dos Códigos de SQLite e Polars'
author: "Seu Nome Completo Aqui"
format:
  html:
    toc: true
    self-contained: true
    code-fold: false
  pdf:
    documentclass: article
    toc: true
---

## Introdução

Este documento reproduz os códigos apresentados na aula sobre **SQLite e Polars**, conforme a atividade solicitada. Todos os blocos de código foram executados e documentados para explicar cada etapa do processo, desde a criação do banco de dados até a realização de consultas complexas com `JOIN`.

***


```{python}
import polars as pl
import sqlite3
import os
import datetime

# --- INÍCIO DO SCRIPT ---

# 1. Registro de Compilação
print(f"Script executado em: {datetime.datetime.now().strftime('%d/%m/%Y às %H:%M:%S')}\n")

# 2. Configuração Inicial e Limpeza
db_file = 'data.db'
if os.path.exists(db_file):
    os.remove(db_file)
    print(f"Arquivo de banco de dados '{db_file}' antigo removido.")

# 3. Conexão com o Banco de Dados
conn = sqlite3.connect(db_file)
cursor = conn.cursor()
print("Conexão com o banco de dados 'data.db' estabelecida.\n")

# 4. Criação da Tabela 'vendas'
cursor.execute('''
CREATE TABLE vendas (
    id INTEGER PRIMARY KEY,
    vendedor TEXT,
    produto TEXT,
    valor REAL,
    data_venda DATE
)
''')
print("--- Tabela 'vendas' criada. ---")

# 5. Inserção de Dados na Tabela 'vendas'
cursor.execute('''
INSERT INTO vendas (vendedor, produto, valor, data_venda)
VALUES
    ('Ana', 'Produto A', 120.5, '2024-09-01'),
    ('Carlos', 'Produto B', 200.0, '2024-10-02'),
    ('Ana', 'Produto C', 150.0, '2024-09-03'),
    ('Bruno', 'Produto A', 300.0, '2024-11-04'),
    ('Carlos', 'Produto C', 100.0, '2024-10-05');
''')
conn.commit()
print("--- Dados inseridos em 'vendas'. ---\n")

# 6. Integração com Polars e Consulta Geral
print("--- Conteúdo completo da tabela 'vendas': ---")
dados_vendas = pl.read_database("SELECT * FROM vendas", conn)
print(dados_vendas)

# 7. Análises e Agregações
print("\n--- Total de vendas por vendedor: ---")
vendas_total = pl.read_database("SELECT vendedor, SUM(valor) as total_vendas FROM vendas GROUP BY vendedor;", conn)
print(vendas_total)

print("\n--- Valor médio de venda por vendedor: ---")
vendas_medias = pl.read_database("SELECT vendedor, AVG(valor) as media_vendas FROM vendas GROUP BY vendedor;", conn)
print(vendas_medias)

print("\n--- Resumo de vendas por vendedor: ---")
vendas_comb = pl.read_database("SELECT vendedor, COUNT(*) as numero_vendas, SUM(valor) as total_vendas, AVG(valor) as media_vendas FROM vendas GROUP BY vendedor;", conn)
print(vendas_comb)

print("\n--- Vendas com valor igual ou superior a R$ 200,00: ---")
ticket_alto = pl.read_database("SELECT * FROM vendas WHERE valor >= 200", conn)
print(ticket_alto)

print("\n--- Volume mensal de vendas: ---")
vendas_mensais = pl.read_database("SELECT strftime('%Y-%m', data_venda) AS mes, SUM(valor) AS total_vendas FROM vendas GROUP BY mes ORDER BY mes", conn)
print(vendas_mensais)

# 8. Criação da Tabela 'produtos'
cursor.execute('''
CREATE TABLE IF NOT EXISTS produtos (
    id INTEGER PRIMARY KEY,
    nome TEXT NOT NULL,
    categoria TEXT NOT NULL,
    preco REAL NOT NULL,
    estoque INTEGER NOT NULL
);
''')
cursor.execute('''
INSERT INTO produtos (nome, categoria, preco, estoque) 
VALUES
    ('Produto A', 'Categoria 1', 100.0, 50),
    ('Produto B', 'Categoria 2', 150.0, 30),
    ('Produto C', 'Categoria 1', 200.0, 20),
    ('Produto D', 'Categoria 2', 250.0, 10),
    ('Produto E', 'Categoria 3', 300.0, 0);
''')
conn.commit()
print("\n--- Tabela 'produtos' criada e dados inseridos. ---")

print("\n--- Conteúdo completo da tabela 'produtos': ---")
dados_produtos = pl.read_database("SELECT * FROM produtos", conn)
print(dados_produtos)

# 9. Consultas com JOIN
print("\n--- Lucro por transação (Valor da Venda - Preço de Custo): ---")
lucros = pl.read_database("""
SELECT v.produto, v.valor AS valor_venda, p.preco AS preco_custo, (v.valor - p.preco) AS lucro
FROM vendas AS v
INNER JOIN produtos AS p ON v.produto = p.nome
""", conn)
print(lucros)

print("\n--- Lucro médio por venda, agrupado por vendedor: ---")
lucro_medio_vendedor = pl.read_database("""
SELECT v.vendedor, AVG(v.valor - p.preco) AS lucro_medio_por_venda
FROM vendas AS v
INNER JOIN produtos AS p ON v.produto = p.nome
GROUP BY v.vendedor
""", conn)
print(lucro_medio_vendedor)

# 10. Fechando a Conexão
conn.close()
print("\nConexão com o banco de dados fechada.")

# --- FIM DO SCRIPT ---
```

